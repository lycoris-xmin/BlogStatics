$(function(){function e(){const e=window.scrollY||window.pageYOffset;if(e>0){if($(".page-header").hasClass("sticky-header"))return;$(".page-header").addClass("sticky-header")}else{if(!$(".page-header").hasClass("sticky-header"))return;$(".page-header").removeClass("sticky-header")}}function t(e,t){let o="";if(e&&e.length)for(let a of e)o=o.concat(`\n        <li>\n          <div>\n            <div class="result-header flex-start-center">\n                <span class="post-badge post-badge-primary">原创</span>\n                <a class="post-link" href="/post/${a.id}">${$.highlightKeyword(a.title,t)}</a>\n            </div>\n            <div class="result-info">\n                ${$.highlightKeyword(a.info,t)}\n            </div>\n          </div>\n        </li>\n        `);o?r.searchResult.removeClass("no-result"):r.searchResult.addClass("no-result"),r.searchResult.find("ul").html(o)}function o(e){if(27!=e&&13!=e&&40!=e&&38!=e)return;if(27==e)return void(r.searchOvalay.hasClass("search-overlay-show")&&(i.mousedownTarget=i.mouseupTarget=!0,r.searchOvalay.trigger("click")));const t=r.searchOvalay.find("div.search-result");if(t.hasClass("no-result"))return;const o=t.find("li.active");if(40==e)if(o&&o.length>0){const e=o.next();e&&e.length&&(o.removeClass("active"),e.addClass("active"),n($("ul.result"),e,"bottom")||s($("ul.result"),e,500,"bottom"))}else r.searchInput.trigger("blur"),$(t.find("li:first")).addClass("active");else if(38==e){if(o&&o.length>0){const e=o.prev();e&&e.length?(e.addClass("active"),n($("ul.result"),e,"top")||s($("ul.result"),e,500,"top")):(r.searchInput.trigger("focus"),setTimeout(()=>{let e=r.searchInput.val();r.searchInput[0].setSelectionRange(e.length,e.length)},0)),o.removeClass("active")}}else 13==e&&(location.href=o.find("a.post-link").attr("href"))}function a(){try{if($("script[layout]").length){const e=$("script[layout]").text();let t=JSON.parse(e);t&&(window.lycoris.online=null!=t.online&&"boolean"==typeof t.online&&t.online)}else window.lycoris.online=!1}catch(e){console.log(e)}}function n(e,t,o){if("top"==o){var a=t.offset().top-e.offset().top;if(a<0)return!1;var n=e.scrollTop();return a+t.outerHeight()<=n+e.height()}var s=t.offset(),r=s.top+t.outerHeight(),i=e.offset(),l=i.top+e.outerHeight();return r<=l&&r>=i.top}function s(e,t,o,a){if("top"==a){h=0;var n=t.offset().top-e.offset().top;e.animate({scrollTop:e.scrollTop()+n},o)}else{const a=t.offset().top-e.offset().top,n=t.outerHeight(),s=e.height();h+=a+n-s,e.animate({scrollTop:h},o)}}const r={header:$("body>div.page-header"),search:$("body>div.page-header").find("div.action").find(".mdi-magnify"),searchOvalay:$("body>div.search-overlay"),searchInput:$("body>div.search-overlay").find("input"),searchResult:$("body>div.search-overlay").find("div.search-result"),totastContainer:$(".totast-container")},i={mousedownTarget:!1,mouseupTarget:!1};let l=localStorage.getItem("clientOrign");l||(l=$.uuid(),localStorage.setItem("clientOrign",l));const c=$.indexDb("lycoris-blog","blog");window.lycoris={loading:{show:function(){$("body").addClass("loading")},hide:function(){setTimeout(()=>{$("body").removeClass("loading");const e=$("div.header-title>div>p");e&&e.length&&e.addClass("focus-in")},300)}},totast:$.lycorisTotast(),route:{toLoginPage:e=>{e=e||`${location.pathname}${location.search}`,location.href=`/authentication/login?redirect=${e}`}},record:async function(e,t=!1){const o={clientOrign:l,route:`${location.pathname}${location.search}`,pageName:e,referer:document.referrer,isPost:t},a=await c.query(e=>e.route==o.route);if(!(a&&a.length&&a[0].time+3e5>+new Date))try{const e=$.createHttpRequest();e.url="/home/browse/record",e.data=o,await e.post(),a&&a.length?(a[0].time=+new Date,c.update(a[0])):c.create({route:o.route,time:+new Date})}catch(e){console.error(e)}},lazysizes:function(){lazySizes.loader.checkElems()},navlink:function(e,t){e=e?$(e):$("a[href]"),$("a[href]").each((e,o)=>{const a=$(o).attr("href");if(a&&a.startsWith("http")){const e=new URL(a).hostname;if(e.replace("www.","")==location.host.replace("www.",""))return;$(o).attr("data-nav-link",a),$(o).removeAttr("href"),t||(t=$(o).attr("target")),$(o).attr("data-nav-target",t||""),$(o).removeAttr("target"),$(o).on("click",function(){const e=$(this).attr("data-nav-link"),t=$(this).attr("data-nav-target"),o=`/external/link?target=${encodeURIComponent(e)}`;"_blank"==t?window.open(o):location.href=o})}})}},$(window).on("scroll",$.throttle(e,200)),r.header.find("span.login").on("click",function(){window.lycoris.route.toLoginPage()}),r.search.on("click",function(){r.searchOvalay.addClass("search-overlay-show"),setTimeout(()=>{r.searchOvalay.find("input").trigger("focus")},300)}),r.searchOvalay.find(">div.card").on("click",function(e){e.stopPropagation()}),r.searchOvalay.on("click",function(){i.mousedownTarget&&i.mouseupTarget&&($(this).removeClass("search-overlay-show").addClass("search-overlay-hide"),setTimeout(()=>{$(this).find("input").val(""),r.searchResult.addClass("no-result"),r.searchResult.find("ul").html("")},300)),i.mousedownTarget=i.mouseupTarget=!1}),r.searchOvalay.on("mousedown",function(e){i.mousedownTarget=e.target===e.currentTarget}),r.searchOvalay.on("mouseup",function(e){i.mouseupTarget=e.target===e.currentTarget});const u=r.searchResult.lineBusy(),d=$.debounce(async()=>{let e=r.searchInput.val();if(e=e.trimEnd().trimStart(),e){u.show();try{const o=$.createHttpRequest();o.url="/post/search",o.data={keyword:e};const a=await o.get();a&&0==a.resCode&&t(a.data.list,e)}finally{u.hide()}}},500);r.searchInput.on("input",d);let h=0;$(document).on("keydown",function(e){o(e.which)}),$("a[route-link]").on("click",function(){const e=$(this).data("href");e!=location.pathname?location.href=e:window.lycoris.totast.info("你已经在此页面了")}),r.header.find("div>img").on("click",function(){"/"!=location.pathname&&(location.href="/")}),r.header.find("a[logout]").on("click",async function(){$(this).setBusy();try{const e=$.createHttpRequest();e.url="/authentication/Logout";const t=await e.post();t&&0==t.resCode&&(window.lycoris.totast.success("退出成功"),setTimeout(()=>{location.reload()},1e3))}finally{$(this).clearBusy()}}),window.onresize=$.debounce(function(){location.reload()},500),this.init=function(){e(),a()},this.init()});