$(function(){async function n(){try{const n=$.createHttpRequest();n.url="/message/configuration";const a=await n.get();a&&0==a.resCode&&(a.data.messageRemind&&a.data.messageRemind.length>0&&(x.configuration.messageRemind=a.data.messageRemind),"number"==typeof a.data.frequencySecond&&(x.configuration.frequencySecond=a.data.frequencySecond))}finally{e()}}async function a(n=!1){y.message.next().addClass("show-loading"),n||y.message.html("");try{const n=$.createHttpRequest();n.url="/message/list",n.data={pageIndex:b.pageIndex,pageSize:b.pageSize};const e=await n.get();if(e&&0==e.resCode){b.count=e.data.count,b.maxPageIndex=$.getMaxPageIndex(e.data.count,b.pageSize);const n=[];for(let a of e.data.list)n.push(t(a)),I[a.id]={pageIndex:1,pageSize:5,maxPageIndex:1,count:a.replyCount,first:!0};d(n),$("html, body").animate({scrollTop:0},500),r($("div[pagination]").find("ul"),b,async()=>{I={},await a()}),$("div[pagination]").addClass("show")}}finally{y.message.next().removeClass("show-loading")}}function e(){if(x.configuration.messageRemind.length>0){let n="";for(let a=0;a<x.configuration.messageRemind.length;a++)n=n.concat(`<li>${a+1}. ${x.configuration.messageRemind[a]}</li>`);$("ul.remind").html(n)}}function t(n){const a=$.getUserAgentImg(n.agentFlag),e=`\n    <div class="card card-border message">\n      <div class="flex-between-center header">\n        <div class="flex-start-center">\n            <div class="avatar">\n                <img src="${n.user.avatar}" onerror="javascript:this.src='./statics/avatar/default_user.jpg'" />\n            </div>\n            <div>\n                <p><span class="name" data-id="${n.user.id}">${n.user.nickName}</span>${n.isOwner?'<span class="owner">博主</span>':""}</p>\n                <span class="time">${n.createTime}</span>\n            </div>\n        </div>\n\n        <div class="flex-end-center">\n          <span>\n            <i class="mdi mdi-map-marker-radius"></i>\n          </span>\n          <span class="address">${n.ipAddress}</span>\n          <img class="client" src="${a.url}"  title="${a.title}"/>\n        </div>\n      </div>\n      <div class="content">\n        ${0==n.status?`<p>${n.content||"-"}</p>`:'<div class="violation"><span>内容涉及敏感词汇，已被博主隐藏...</span></div>'}\n      </div>\n      <div class="flex-end-center">\n        <div class="comment">\n          <div class="body">\n            <ul>\n              ${s(n.redundancy)}\n            </ul>\n            <div class="line-loading-preloader">\n              <div class="line-loading-preloader-inner"></div>\n              <span class="loading-text">评论加载中...</span>\n            </div>\n          </div>\n          <div class="pagination flex-end-center" comment-pagination>\n            <ul class="pagination">\n            </ul>\n          </div>\n          <div class="reply-panel">\n            <div class="input-area">\n              <textarea class="input-control" name="reply" maxlength="100" data-reply-name=""></textarea>\n              <p><span>0</span>/100</p>\n            </div>\n            <div>\n              ${i(n.id,n.replyCount)}\n              <div>\n                <button class="btn" hide-reply type="button">不说了</button>\n                <button class="btn" reply type="button" data-message data-id="${n.id}">\n                  <span class="mdi mdi-send-circle-outline"></span>\n                  <span class="mdi mdi-loading mdi-spin"></span>\n                  <span class="text">回复</span>\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n    `,t=document.createElement("div");return $(t).addClass("card card-border message"),e}function i(n,a){return a<=2?"":`\n      <button redundancy class="btn" type="button" data-message="${n}">\n        <span class="mdi mdi-dots-horizontal"></span>\n        <span class="mdi mdi-loading mdi-spin"></span>\n        查看全部 ${a} 条回复\n      </button>\n      `}function s(n,a=!1){function e(n){return 0==n.status?`<p class="content">${n.repliedUser&&n.repliedUser.id>0?`<span class="replied" data-id="${n.repliedUser.id}">@${n.repliedUser.nickName}</span>`:""}${n.content}</p>`:'<p class="violation"><span>内容涉及敏感词汇，已被博主隐藏...</span></p>'}if(!n||!n.length)return"";let t="",i="";a&&(i='class="scale"');for(let a of n){const n=$.getUserAgentImg(a.agentFlag);t=t.concat(`\n      <li ${i}>\n        <div class="flex-start-center">\n          <div class="avatar">\n              <img src="${a.user.avatar}" onerror="javascript:this.src='./statics/avatar/default_user.jpg'" />\n          </div>\n          <div class="nickname">\n            <span class="name">${a.user.nickName}</span>\n            ${a.isOwner?'<span class="owner">博主</span>':""}\n            <span style="padding-right:5px">:</span>\n          </div>\n          ${e(a)}\n        </div>\n        <div class="flex-end-center info">\n          <span class="time">${a.createTime}</span>\n          <span class="ipaddress"><i class="mdi mdi-map-marker-radius"></i>${a.ipAddress}</span>\n          <img class="client" src="${n.url}" title="${n.title}"/>\n          <span reply class="reply" data-name="${a.user.nickName}" data-id="${a.id}">回复</span>\n        </div>\n      </li>\n      `)}return t}function d(n,a=!1){if(n&&n.length){a&&y.message.find("div.message").length==b.pageSize&&y.message.find("div.message:last-child").remove();for(let e of n){const n=$(e);a?y.message.prepend(n):y.message.append(n),n.find("button[redundancy]").on("click",g),n.find("button[reply]").on("click",c),n.find("button[hide-reply]").on("click",p),n.find("span[reply]").on("click",f),n.find(".input-control").on("input",m)}}}function r(n,a,e){if(a.maxPageIndex>1){const t=$.getPageNumber(a.pageIndex,a.maxPageIndex);let i="";i='\n    <li class="page-item page-btn" data-index="-1">\n      <span class="page-link">上一页</span>\n    </li>\n    ';for(let n of t)i+=`\n      <li class="page-item page-number ${n==a.pageIndex?"active":""}" data-index="${n}">\n        <span class="page-link">${n}</span>\n      </li>\n      `;i+='\n    <li class="page-item page-btn" data-index="1">\n      <span class="page-link">下一页</span>\n    </li>\n    ',n.html(i),l(n,a,e)}else n.parent().remove()}function l(n,a,e){n.find(">li.page-number").on("click",function(){const t=$(this).data("index");a.pageIndex!=t&&(a.pageIndex=t,a.maxPageIndex>t?r(n,a,e):(n.find(">li.page-number").removeClass("active"),$(this).addClass("active")),e())}),n.find(">li.page-btn").on("click",function(){const e=parseInt($(this).data("index"));let t=a.pageIndex+e;t<1||t>a.maxPageIndex||n.find(`>li.page-number[data-index="${t}"]`).trigger("click")})}function o(){const n=$('div.input-area[data-reply="1"]');if(n&&n.length)for(let a of n)$(a).parent().find("button[hide-reply]").trigger("click")}async function c(){if(!window.lycoris.online){const n=await w.confirm("鉴于小破站资金资源不足，需要已注册用户登录后才允许留言","用户登录提醒");return void(n&&window.lycoris.route.toLoginPage())}const n=$(this).parent().parent().parent();if("1"!=n.find("div.input-area").attr("data-reply"))return o(),void n.find("div.input-area").slideDown(()=>{n.find("div.input-area").attr("data-reply","1"),n.find("button[hide-reply]").show();const a=n.find("button[reply]");a.attr("data-message",""),a.find(".text").text("发布"),n.find("textarea").focus()});if("none"==n.find("div.input-area").css("display"))return;if(!h())return;const a=n.find("textarea");let e=v(a);if(e){$(this).setBusy();try{const n=$.createHttpRequest();n.url="/message/reply/publish",n.data={messageId:$(this).attr("data-message")||$(this).data("id"),content:e};const t=await n.post();if(t&&0==t.resCode){window.lycoris.totast.success("发布成功");const e=s([t.data],!0),i=$(e),d=$(this).parent().parent().parent().parent(),l=d.find("div.body").find("ul");l.prepend(i),i.find("span[reply]").on("click",f);const o=l.find("li");o.length>5&&$(o[o.length-1]).remove(),p.apply(this),a.val(""),I[n.data.messageId].count++,I[n.data.messageId].count>5&&(I[n.data.messageId].first=!1,I[n.data.messageId].maxPageIndex=$.getMaxPageIndex(I[n.data.messageId].count,I[n.data.messageId].pageSize),r(d.find("div[comment-pagination]").find("ul"),I[n.data.messageId],async()=>{u(d,n.data.messageId,I[n.data.messageId])}))}}finally{$(this).clearBusy()}}}function p(){const n=$(this).parent().parent().parent();n.find("button[hide-reply]").hide(),n.find("div.input-area").slideUp(()=>{n.find("div.input-area").attr("data-reply","0"),n.find("div.input-area").find("textarea").val("");const a=n.find("button[reply]");a.find(".text").text("回复"),a.attr("data-message","")})}function g(){const n=$(this).attr("data-message");n&&(I[n].maxPageIndex=$.getMaxPageIndex(I[n].count,I[n].pageSize),u($(this).parent().parent().parent(),n,I[n]))}async function u(n,a,e){const t=n.find("button[redundancy]");t&&t.length?t.setBusy():n.find("div.line-loading-preloader").addClass("show-loading ");try{const i=$.createHttpRequest();i.url="/message/reply/list",i.data={messageId:a,pageIndex:e.pageIndex,pageSize:e.pageSize};const d=await i.get();if(d&&0==d.resCode){e.first&&d.data.list.splice(0,2);const i=s(d.data.list,!0),l=$(i);e.first?n.find("div.body").find(">ul").append(l):n.find("div.body").find(">ul").html(l),l.find("span[reply]").on("click",f),t&&t.length&&setTimeout(()=>{t.fadeOut(()=>{t.remove()})},100);const o=n.find("div[comment-pagination]");e.first&&(r(o.find("ul"),e,async()=>{u(n,a,e)}),e.first=!1),o.hasClass("show")||o.addClass("show")}}finally{t&&t.length?t.clearBusy():n.find("div.line-loading-preloader").removeClass("show-loading ")}}async function f(){if(!window.lycoris.online){const n=await w.confirm("鉴于小破站资源限制，需要已注册用户登录后才允许留言","用户登录提醒");return void(n&&window.lycoris.route.toLoginPage())}const n=$(this).data("name"),a=$(this).parent().parent().parent().parent().parent(),e=a.find('textarea[name="reply"]'),t=e.val(),i=`@${n}`,s=e.attr("data-reply-name")||"";t.startsWith(s)&&i==s||(t.startsWith(s)?e.val(`${t.replace(s,i)} `):e.val(`${i} ${t}`),e.attr("data-reply-name",i)),a.find("button[reply]").attr("data-message",$(this).attr("data-id")),a.find("button[reply]").attr("data-reply-name",i);const d=a.find("div.reply-panel");if("1"!=d.find("div.input-area").attr("data-reply"))return o(),void d.find("div.input-area").slideDown(()=>{d.find("div.input-area").attr("data-reply","1"),d.find("button[hide-reply]").show(),d.find("button[reply]").find(".text").text("发布"),e.focus()});setTimeout(()=>{e.focus()},0)}function m(){const n=$(this).val(),a=parseInt($(this).attr("maxlength"));let e=$(this).data("reply-name"),t=n.length;e&&(n.startsWith(`${e} `)?t-=`${e} `.length:n.startsWith(e)&&(t-=e.length)),n.startsWith(e)?a!=100+e.length&&$(this).attr("maxlength",100+e.length):100!=a&&$(this).attr("maxlength",100),$(this).next().find("span").text(t),n.length>=a?$(this).next().css("color","var(--color-danger)"):$(this).next().css("color","var(--color-dark-light)")}function v(n){let a=n.val();const e=n.data("reply-name");return e&&a.startsWith(e)?a=a.replace(e,""):n.parent().next().find("button[reply]").attr("data-message",""),a.trim()}function h(){if(0==x.configuration.frequencySecond)return!0;k=k||+new Date(2e3,1,1);const n=+new Date;return k>=n?(window.lycoris.totast.info("你发布的频率太快了，请休息一会吧"),!1):(k=n+1e3*x.configuration.frequencySecond,localStorage.setItem("x-message",k),!0)}const y={message:$("div.message-panel").find("div.body"),pagination:$("div.pagination-btn").find("ul.pagination")},x={configuration:{messageRemind:[],frequencySecond:0}},b={pageIndex:1,pageSize:10,count:0,maxPageIndex:1},w=$.sweetAlert();let I={};$('textarea[name="message"]').on("input",function(){const n=$(this).val(),a=$(this).next(),e=parseInt($(this).attr("maxlength"));a.find("span").text(n.length),n.length>=e?a.css("color","var(--color-danger)"):a.css("color","var(--color-dark-light)")}),$("button[login]").on("click",function(){window.lycoris.route.toLoginPage()}),$("button[publish]").on("click",async function(){if($("div.login-wrap").length)return;const n=$('textarea[name="message"]').val();if(""!=n&&""!=n.trim()&&h()){$(this).setBusy();try{const a=$.createHttpRequest();a.url="/message/publish",a.data={content:n};const e=await a.post();if(e&&0==e.resCode){const n=t(e.data);d([n],!0),$('textarea[name="message"]').val("").focus()}}finally{$(this).clearBusy()}}});let k=localStorage.getItem("x-message");this.init=async function(){await n(),window.lycoris.loading.hide(),await a(!0)},this.init()});