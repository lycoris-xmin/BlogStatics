$(function(){async function e(){try{const e=window.lycoris.createRequest();e.url="/dashboard/statistics/today";const n=await e.get();n&&0==n.resCode&&t(n.data)}catch(e){console.error(e)}}function t(e){const t=$(".statistics-body"),r=t.find("div[pv]");r.find(".value").attr("data-number",e.pvBrowse),n(r.find(".percent"),e.pvBrowsePercent);const a=t.find("div[uv]");a.find(".value").attr("data-number",e.uvBrowse),n(a.find(".percent"),e.uvBrowsePercent);const i=t.find("div[interactive]");i.find(".value").attr("data-number",e.commentMessage),n(i.find(".percent"),e.commentMessage);const s=t.find("div[elapsed-milliseconds]");s.find(".value").attr("data-number",e.elapsedMilliseconds),n(s.find(".percent"),e.elapsedMillisecondsDifference),$("p.online-user").removeClass("loading"),e.onlineUsers>0&&($("p.online-user").find("span.value").text(e.onlineUsers),$("p.online-user").addClass("online"));const o=[];t.find("p.value").each((e,t)=>{const n=c(t);n.minStep=1,n.targetNumberHandle=(e=>parseFloat($(e).attr("data-number")||0)),o.push(n)}),t.find("p.percent>span").each((e,t)=>{const n=c(t);n.minStep=1,n.targetNumberHandle=(e=>parseFloat($(e).attr("data-number")||0)),o.push(n)}),$("div.statistics").find("div.loading").fadeOut(300,function(){$(this).remove(),o.forEach(e=>e.paly(5e3))})}function n(e,t,n=!1){if(0==t)return;let r=`<span data-number="${t}">0</span>`;n?t<0?r=r.concat('<i class="mdi mdi-arrow-up-thick"></i>'):t>0&&(r=r.concat('<i class="mdi mdi-arrow-down-thick"></i>')):t>0?r=r.concat('<i class="mdi mdi-arrow-up-thick"></i>'):t<0&&(r=r.concat('<i class="mdi mdi-arrow-down-thick"></i>')),e.html(r),e.addClass(t>0?"up":t<0?"down":"")}async function r(){try{const e=window.lycoris.createRequest();e.setBaseUrl(),e.url="/statics/world/world.json";const t=await e.get();return t}catch(e){return console.error(e),{}}}async function a(e){try{const t=window.lycoris.createRequest();t.url="/dashboard/worldmap/list";const n=await t.get();if(n&&0==n.resCode){const t=[];for(let r of n.data.list){const n={country:u(r.country),count:r.count,flag:""};n.flag=e[n.country];const a=t.findIndex(e=>e.country==n.country);a>-1?t[a].count+=n.count:t.push(n)}return t.sort((e,t)=>t-e),t}}catch(e){return}}async function i(){const e=$("#world-map"),t=echarts.init(e[0],null,{renderer:"canvas",useDirtyRect:!1}),{geo:n,nameMap:i,flag:o}=await r();if(!n&&!i&&!o)return void window.lycoris.toast.error("加载地图数据失败");echarts.registerMap("world",n);const c={tooltip:{trigger:"item",showDelay:0,transitionDuration:.2,borderColor:"#666",formatter:function(e){if(e.name)return e.name+" : "+(isNaN(e.value)?0:parseInt(e.value))}},visualMap:{show:!1,min:0,max:1e6,inRange:{color:["#1BA3E8","#0082C4","#0062A1","#004580","#00295F"]},text:["High","Low"],calculable:!0},series:[{nameMap:i,name:"World",type:"map",map:"world",emphasis:{label:{show:!0}},zoom:1.2,roam:!1,data:[]}]};t.setOption(c);let u=await a(o);u||(u=[]),s(u),t.setOption({series:[{data:u.map(e=>({name:e.country,value:e.count}))}]}),window.addEventListener("resize",t.resize)}function s(e){if(!e||!e.length)return;const t=e.map(e=>e.count).reduce((e,t)=>e+t),n=e.map(e=>({country:e.country,count:e.count,flag:e.flag,percent:(e.count/t*100).toFixed(2)}));o(n)}function o(e){let t="";for(let n of e)t+=t.concat(`\n      <li class="flex-between-center">\n        <div>\n          <img src="/statics/flags/${n.flag}.png" />\n          <span class="country">${n.country}</span>\n        </div>\n        <div class="flex-center-center">\n          <span class="value">${n.count}</span>\n          <div class="progress-bar">\n              <div style="width:${n.percent}%">\n              </div>\n          </div>\n        </div>\n      </li>\n      `);$("ul.world-map").html(t)}function c(e){function t(){n.currentNumber+=n._increment,n.currentNumber>n._targetNumber&&(n.currentNumber=n._targetNumber),n.el.textContent=Math.floor(n.currentNumber),n.currentNumber<n._targetNumber?requestAnimationFrame(t):n.complete&&"function"==typeof n.complete&&n.complete()}const n={el:e,currentNumber:0,_increment:0,_targetNumber:0,minStep:void 0,complete:void 0,paly:(e=2e3,r,a)=>{null==a&&n.sourceNumberHandle&&"function"==typeof n.sourceNumberHandle?(n.currentNumber=n.sourceNumberHandle(n.el),n.currentNumber=parseFloat(n.currentNumber),n.currentNumber=isNaN(n.currentNumber)?0:n.currentNumber):n.currentNumber=null==a||0,n.targetNumberHandle&&"function"==typeof n.targetNumberHandle?(n._targetNumber=n.targetNumberHandle(n.el),n._targetNumber=parseFloat(n._targetNumber),n._targetNumber=isNaN(n._targetNumber)?0:n._targetNumber):n.currentNumber=r,n.currentNumber<n._targetNumber&&(n._increment=Math.floor((n._targetNumber-n.currentNumber)/(e/16)),n.minStep&&n.minStep>n._increment&&(n._increment=n.minStep),t())},sourceNumberHandle:function(){return parseFloat(n.el.innerText)},targetNumberHandle:void 0};return n}function u(e){return e.indexOf("香港")>-1||e.indexOf("澳门")>-1||e.indexOf("台湾")>-1?"中国":e}async function l(){try{const e=window.lycoris.createRequest();e.url="/dashboard/statistics/browse/list",e.data={pageIndex:b.pageIndex,pageSize:b.pageSize};const t=await e.get();t&&0==t.resCode&&d(t.data.list)}catch(e){console.error(e)}finally{$("div.domain-statistics").find("ul[browse-statistics]").next().fadeOut(300,function(){$(this).remove()})}}function d(e){if(!e||!e.length)return;let t="";for(let n of e)t=t.concat(`\n      <li class="flex-between-center">\n        <span title="${n.pageName}" data-route="${n.toute}" data-page-name="${n.pageName}">${n.pageName}</span>\n        <span>${n.count}</span>\n      </li>\n      `);$("div.domain-statistics").find("ul[browse-statistics]").html(t)}async function m(){try{const e=window.lycoris.createRequest();e.url="/dashboard/statistics/referer/list",e.data={pageIndex:w.pageIndex,pageSize:w.pageSize};const t=await e.get();t&&0==t.resCode&&f(t.data.list)}catch(e){console.error(e)}finally{$("div.domain-statistics").find("ul[referer-statistics]").next().fadeOut(300,function(){$(this).remove()})}}function f(e){if(!e||!e.length)return;let t="";for(let n of e)t=t.concat(`\n      <li class="flex-between-center">\n        <span title="${n.domain}" data-referer="${n.referer}" data-domain="${n.domain}">${n.domain}</span>\n        <span>${n.count}</span>\n      </li>\n      `);$("div.domain-statistics").find("ul[referer-statistics]").html(t)}async function p(){try{const e=window.lycoris.createRequest();e.url="/dashboard/statistics/useragent/list";const t=await e.get();if(t&&0==t.resCode)for(let e in t.data)g(e,t.data[e])}catch(e){console.error(e)}finally{$("div.other-statistics").find("div.line-loading-preloader").fadeOut(300,function(){$(this).remove()})}}async function g(e,t){if(!t||!t.length)return;e=e.toLocaleLowerCase();let n="";for(let r of t)n=n.concat(`\n      <li class="flex-between-center">\n        <div>\n          <img src="/statics/icon/${"browseclient"==e?"browser":"os"==e?"os":"device"}/${r.icon}" />\n          <span>${r.name}</span>\n        </div>\n        <span>${r.count}</span>\n      </li>\n      `);$(`ul[${e}-statistics]`).html(n)}const b={count:0,list:[],pageIndex:1,pageSize:15},w={count:0,list:[],pageIndex:1,pageSize:15};this.init=function(){e(),i(),window.lycoris.loading.hide(),l(),m(),p()},this.init()});