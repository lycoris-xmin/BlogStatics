$(function(){function e(){function i(){return $.createHttpRequest()}function o(e,i,o=null){const t=$.createHttpRequest();return t.url="/staticfile/upload",t.formData={uploadType:i,fileName:o},t.post({file:e})}function t(){const e={_:[],on:(i,o)=>{const t=e._.findIndex(e=>e.channel==i);t<0?e._.push({channel:i,callback:o}):e._[t]={channel:i,callback:o}},unbind:i=>{const o=e._.findIndex(e=>e.channel==i);o>-1&&e._.splice(o,1)},call:(i,...o)=>{const t=e._.findIndex(e=>e.channel==i);t>-1&&e._[t].callback.apply(e,o)}};return e}function a(){return{createObjectURL:e=>{let i=window.URL||window.webkitURL;return i.createObjectURL(e)}}}return{isDebugger:window.lycoris.isDebugger,console:window.lycoris.console,createSignalR:e=>$.createSignalR(e),createLycoris:e,createRequest:i,fileUpload:o,events:t(),totast:$.totast,swal:$.sweetAlert(),tool:a(),go:(e,i=!0)=>{location.href=i?`${window.lycoris.console}${e}`:e},open:e=>{window.open(e)},changeConsole:e=>{`${e}/dashboard`!=location.pathname&&(location.href=location.pathname.replace(window.lycoris.console,e))}}}function i(){const e={instance:t,create:(e,i)=>{t&&t.create({iframe:!0,title:e,url:i},!0)},active:e=>{let i=$("#iframe-content").find(`.nav-item>a[data-url="${e}"]`);i&&i.length&&$(i).trigger("click")},remove:(i,o)=>{let t=$("#iframe-content").find(`.nav-item>a[data-url="${i}"]`);t&&t.length&&t.parent().find("i.mt-close-tab").trigger("click"),o&&setTimeout(()=>{e.active(o)},0)},getCurrentTab:function(){let e=$("#iframe-content").find(".nav-item>a.active");if(e&&e.length)return{name:$(e).text(),url:$(e).attr("data-url")}},updateCurrentTab:function(e,i){let o=$("#iframe-content").find(".nav-item>a.active");if(o&&o.length){o.attr("data-url",i),o.data("url",i),o.text(e);const t=o.data("id");$(`#${t}`).attr("src",i)}}};return e}async function o(){window.lycoris.signalR=$.createSignalR(`${window.lycoris.console}/hub/dashboard`,window.lycoris.isDebugger),await window.lycoris.signalR.connect(),window.lycoris.signalR.on("refresh",async function(){location.reload()}),window.lycoris.signalR.on("logout",async function(){await window.lycoris.swal.warn("您的帐号已在其他设备登录"),location.href=`${window.lycoris.console}/authentication/login`})}$("body").on("click","[data-stopPropagation]",function(e){e.stopPropagation()}),$(".lyear-scroll")[0]&&$(".lyear-scroll").each(function(){new PerfectScrollbar(this,{swipeEasing:!1,suppressScrollX:!0})}),$(document).on("click",".lyear-aside-toggler",function(){$(".lyear-layout-sidebar").toggleClass("lyear-aside-open"),$("body").toggleClass("lyear-layout-sidebar-close"),0==$(".lyear-mask-modal").length?$('<div class="lyear-mask-modal"></div>').prependTo("body"):$(".lyear-mask-modal").remove()}),$(document).on("click",".lyear-mask-modal",function(){$(this).remove(),$(".lyear-layout-sidebar").toggleClass("lyear-aside-open"),$("body").toggleClass("lyear-layout-sidebar-close")}),$(document).on("click",".nav-item-has-subnav > a",function(){$subnavToggle=jQuery(this),$navHasSubnav=$subnavToggle.parent(),$topHasSubNav=$subnavToggle.parents(".nav-item-has-subnav").last(),$subnav=$navHasSubnav.find(".nav-subnav").first(),$viSubHeight=$navHasSubnav.siblings().find(".nav-subnav:visible").outerHeight(),$scrollBox=$(".lyear-layout-sidebar-info"),$navHasSubnav.siblings().find(".nav-subnav:visible").slideUp(500).parent().removeClass("open"),$subnav.slideToggle(300,function(){$navHasSubnav.toggleClass("open");var e=0;pervTotal=$topHasSubNav.prevAll().length,boxHeight=$scrollBox.outerHeight(),innerHeight=$(".sidebar-main").outerHeight(),thisScroll=$scrollBox.scrollTop(),thisSubHeight=$(this).outerHeight(),footHeight=121,footHeight+innerHeight-boxHeight>=48*pervTotal&&(e=48*pervTotal),1==$subnavToggle.parents(".nav-item-has-subnav").length?$scrollBox.animate({scrollTop:e},300):"undefined"!=typeof $viSubHeight&&null!=$viSubHeight?(e=thisScroll+thisSubHeight-$viSubHeight,$scrollBox.animate({scrollTop:e},300)):thisScroll+boxHeight-$scrollBox[0].scrollHeight==0&&(e=thisScroll-thisSubHeight,$scrollBox.animate({scrollTop:e},300))})}),$(document).on("click",".nav-item .multitabs",function(){$(".nav-item").removeClass("active"),$(".nav-subnav li").removeClass("active"),$(this).parents("li").addClass("active"),$(this).parents(".nav-item-has-subnav").addClass("open").first().addClass("active")});const t=$("#iframe-content").multitabs({iframe:!0,refresh:"no",nav:{backgroundColor:"#ffffff"},init:[{...window.lycoris.main}]});delete window.lycoris.main,window.lycoris.multitabs=i(),Object.assign(window.lycoris,e()),o();const a={profile:$("#user-profile-Modal").bootstrapModal(),password:$("#change-password-Modal").bootstrapModal()},n={profile:{file:void 0,nickName:"",avatar:"",email:"",qq:"",weChat:"",github:"",gitee:"",bilibili:"",cloudMusic:""}},l=$("body").busy();$("a[profile]").on("click",async function(){const e=window.lycoris.createRequest();e.url="/user/brief";const i=await e.get();i&&0==i.resCode&&(Object.assign(n.profile,i.data),a.profile.show())}),$("a[change-password]").on("click",function(){a.password.show()}),$("a[logout]").on("click",async function(){const e=await window.lycoris.swal.confirm("确定要退出登录吗？");if(e){l.show("正在注销中，请稍候...");try{const e=window.lycoris.createRequest();e.url="/authentication/logout";const i=await e.post();i&&0==i.resCode&&(l.show("注销成功，即将返回登录页面"),setTimeout(()=>{window.lycoris.go("/authentication/login")},1e3))}catch{l.hide()}}}),a.profile.handleShow(function(){a.profile.find(".avatar>img").attr("src",n.profile.avatar),a.profile.find("form").formAutoFill(n.profile)}),a.profile.find("p.more-text>span").on("click",function(){const e=this;$(this).hasClass("show")?a.profile.find("div.more").slideUp(300,function(){$(e).removeClass("show")}):a.profile.find("div.more").slideDown(300,function(){$(e).addClass("show")})}),a.profile.find(".avatar>img").on("click",function(){$(this).next().trigger("click")}),a.profile.find(".avatar>input").on("change",function(){n.profile.file=$(this)[0].files[0];const e=window.lycoris.tool.createObjectURL(n.profile.file);$(this).prev().attr("src",e),$(this).val("")}),a.profile.find("button[save]").on("click",async function(){const e=a.profile.find("form").toJson(),i=Object.keys(e);for(let o in n.profile)i.includes(o)&&e[o]==n.profile[o]&&delete e[o];if(!Object.keys(e).length&&null==n.profile.file)return void a.profile.hide();let o=!0;if(e.email&&(o=await window.lycoris.swal.confirm("邮箱修改后你需要重新使用新邮箱作为帐号进行登录","确定要修改邮箱吗？")),o){$(this).setBusy();try{const i=window.lycoris.createRequest();i.url="/user/brief/update",i.formData={...e};const o=n.profile.file?await i.post({file:n.profile.file}):await i.post();o&&0==o.resCode&&(n.profile.file=void 0,window.lycoris.totast.success("保存成功"),e.email?setTimeout(async()=>{await window.lycoris.swal.warn("由于你修改了邮箱，你需要使用新邮箱进行登录","登录通知"),window.lycoris.go("/authentication/login")},500):(a.profile.hide(),$(".dropdown-profile").find(">a>img").attr("src",o.data.avatar),$(".dropdown-profile").find(">a>span").text(o.data.nickName)))}finally{$(this).clearBusy()}}}),this.init=function(){a.profile.find("div.more").slideUp(),$('[data-toggle="tooltip"]').tooltip()},this.init()});