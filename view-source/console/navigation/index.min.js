$(function(){async function t(t,e){const n=window.lycoris.createRequest();n.url=`${a}/list`,n.data={pageIndex:t,pageSize:e};const i=$(".filter-panel").toJson();for(let t in i){const e=i[t];(e||"number"==typeof e)&&(n.data[t]=i[t])}const o=await n.get();return o&&0==o.resCode?o.data:{}}function e(){s.options.toolbar=".table-tool",s.options.showCheckbox=!1,s.options.showColumns=!1,s.options.autoHeight=!0,s.options.resize=!0,s.options.pageSizeResize=!0,s.columns=[{column:"name",title:"收录名称",width:"300px"},{column:"url",title:"收录地址",render:function(t,e){return`<a class="link" href="${t}" target="_blank">${t}</a>`}},{column:"groupName",title:"收录分组",align:"center",width:"200px",render:function(t,e){return`<span class="badge badge-info">${t}</span>`}},{column:"hrefCount",title:"收录热度",width:"120px",align:"center"},{column:"action",title:"操作",class:"cell-action action-2",align:"left",render:function(t,e,n){let i="";return i=i.concat('\n          <button class="info" data-toggle="tooltip" data-placement="top" title="编辑">\n            <i class="mdi mdi-pencil"></i>\n            <i class="mdi mdi-loading mdi-spin"></i>\n          </button>\n          '),i=i.concat('\n          <button class="delete" data-toggle="tooltip" data-placement="top" title="删除">\n            <i class="mdi mdi-delete"></i>\n            <i class="mdi mdi-loading mdi-spin"></i>\n          </button>\n        '),i},events:{"click .info":function(t,e,n,i){d.index=i,d.row=n,c.createorupdate.show()},"click .delete":async function(t,e,n,i){const o=await window.lycoris.swal.confirm("数据删除后不可恢复","确定要删除吗");if(o){$(t.currentTarget).setBusy();try{const e=window.lycoris.createRequest();e.url=`${a}/delete`,e.data={id:n.id};const i=await e.post();i&&0==i.resCode&&(window.lycoris.totast.success("删除成功"),s.removeRow("id",n.id))}finally{$(t.currentTarget).clearBusy()}}}}}],s.init(),s.request=t,s.loadCompelte=(()=>{$('[data-toggle="tooltip"]').tooltip()})}async function n(t){const e=window.lycoris.createRequest();e.url=`${a}/group/list`;const n=await e.get();n&&0==n.resCode&&(d.groups=n.data.list,t&&"function"==typeof t&&t())}function i(){const t=c.setting.find("ul.group-list");let e=o(d.groups);t.html(e),t.find(".mdi-pencil").on("click",async function(){const t=this,e=$(this).parent().parent().parent().attr("data-id");await window.lycoris.swal.custome({title:"修改收录分组",text:$(t).parent().parent().prev().text(),input:"text",inputAttributes:{autocapitalize:"off"},showCancelButton:!0,confirmButtonText:"保 存",cancelButtonText:"取 消",showLoaderOnConfirm:!0,preConfirm:async t=>{try{const n=window.lycoris.createRequest();n.url=`${a}/group/update`,n.data={id:e,groupName:t};const o=await n.post();return o&&0==o.resCode&&(d.groups.push(o.data),i()),o}catch(t){window.lycoris.totast.error("新增失败")}},allowOutsideClick:()=>!window.lycoris.swal._this.isLoading()})}),t.find(".mdi-delete").on("click",async function(){const t=$(this).parent().parent().parent().attr("data-id"),e=await window.lycoris.swal.confirm("数据删除后不可恢复","确定要删除吗");if(e){$(this).parent().addClass("loading");try{const e=window.lycoris.createRequest();e.url=`${a}/group/delete`,e.data={id:t};const n=await e.post();if(n&&0==n.resCode){const e=c.setting.find("ul.group-list").find(`li[data-id="${t}"]`);e.slideUp(300,()=>{e.remove()}),d.groups=d.groups.filter(e=>e.value!=t)}}finally{$(this).parent().removeClass("loading")}}})}function o(t){if(!t||!t.length)return"";let e="";for(let n of t)e=e.concat(`\n      <li data-id="${n.value}">\n        <p>${n.name}</p>\n        <div class="flex-center-center">\n          <div>\n            <span class="mdi mdi-pencil"></span>\n            <span class="mdi mdi-loading mdi-spin"></span>\n          </div>\n          <div>\n            <span class="mdi mdi-delete"></span>\n            <span class="mdi mdi-loading mdi-spin"></span>\n          </div>\n        </div>\n      </li>`);return e}const a="/navigation",s=$("#tb_departments").table(),r={search:$(".table-tool").find("button.btn-success"),create:$(".table-tool").find("button.btn-info"),setting:$(".table-tool").find("button.btn-cyan")},c={createorupdate:$("#createorupdate-Modal").bootstrapModal(),setting:$("#group-Modal").bootstrapModal()},l=c.createorupdate.find('select[name="groupId"]').bootstrapSelectpicker(),d={index:-1,row:{},groups:[],loadGroups:!1};r.search.on("click",async function(){$(this).setBusy();try{await s.load()}finally{$(this).clearBusy()}}),r.create.on("click",function(){c.createorupdate.show()}),r.setting.on("click",async function(){if(d.loadGroups)c.setting.show();else{$(this).setBusy();try{await n(()=>{c.setting.show()}),d.loadGroups=!0}finally{$(this).clearBusy()}}}),c.createorupdate.find("button[append-option]").on("click",async function(){await window.lycoris.swal.custome({title:"新增收录分组",input:"text",inputAttributes:{autocapitalize:"off"},showCancelButton:!0,confirmButtonText:"确 定",cancelButtonText:"取 消",showLoaderOnConfirm:!0,preConfirm:async t=>{try{const e=window.lycoris.createRequest();e.url=`${a}/group/create`,e.data={groupName:t};const n=await e.post();return n&&0==n.resCode&&l.append({value:n.data.value,name:n.data.name}).set("-1").enable(),n}catch(t){window.lycoris.totast.error("新增失败")}},allowOutsideClick:()=>!window.lycoris.swal._this.isLoading()})}),c.createorupdate.handleShow(()=>{d.groups&&d.groups.length&&l.setOptions(d.groups),d.index>-1&&(c.createorupdate.find('input[name="name"]').val(d.row.name),c.createorupdate.find('input[name="url"]').val(d.row.url),c.createorupdate.find('input[name="favicon"]').val(d.row.favicon),l.set(d.row.groupId))}),c.createorupdate.handleHidden(()=>{c.createorupdate.find("form").find("input").val(""),l.set(""),d.index=-1,d.row={}}),c.createorupdate.find("button[save]").on("click",async function(){const t=c.createorupdate.find("form").toJson();if(t.name)if(t.url)if($.regex.url(t.url)){d.index>-1&&(t.id=d.row.id),$(this).setBusy();try{const e=window.lycoris.createRequest();e.url=-1==d.index?`${a}/create`:`${a}/update`,e.data={...t};const n=await e.post();n&&0==n.resCode&&(window.lycoris.totast.success("保存成功"),c.createorupdate.hide(),-1==d.index?s.createRow(n.data,!1):s.updateRow(d.index,n.data))}finally{$(this).clearBusy()}}else window.lycoris.totast.warn("收录地址格式错误");else window.lycoris.totast.warn("收录地址不能为空");else window.lycoris.totast.warn("收录名称不能为空")}),c.setting.handleShow(i),c.setting.find(".tool>div>.btn-success").on("click",async function(){const t=$(this).parent().parent().next();t.addClass("loading");try{await n(),i()}finally{t.removeClass("loading")}}),c.setting.find(".tool>div>.btn-info").on("click",function(){window.lycoris.swal.custome({title:"新增收录分组",input:"text",inputAttributes:{autocapitalize:"off"},showCancelButton:!0,confirmButtonText:"保 存",cancelButtonText:"取 消",showLoaderOnConfirm:!0,preConfirm:async t=>{if(!t)return{};try{const e=window.lycoris.createRequest();e.url=`${a}/group/create`,e.data={groupName:t};const n=await e.post();return n&&0==n.resCode&&(d.groups.push(n.data),i()),n}catch(t){window.lycoris.totast.error("新增失败")}},allowOutsideClick:()=>!window.lycoris.swal._this.isLoading()})}),c.setting.find("button[save]").on("click",async function(){const t=c.setting.find("ul.group-list").find("li"),e=[];t.each((t,n)=>{const i=$(n).attr("data-id");e.push(i)});let n=!0;for(let t=0;t<e.length;t++)if(e[t]!=d.groups[t].value){n=!1;break}if(n)c.setting.hide();else{$(this).setBusy();try{const t=window.lycoris.createRequest();t.url=`${a}/group/order`,t.data={ids:e};const n=await t.post();n&&0==n.resCode&&(window.lycoris.totast.success("保存成功"),c.setting.hide())}finally{$(this).clearBusy()}}}),this.init=function(){e(),window.lycoris.loading.hide(),new Sortable(c.setting.find("ul.group-list")[0],{animation:150,easing:"cubic-bezier(1, 0, 0, 1)"}),s.load()},this.init()});