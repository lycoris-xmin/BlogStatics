$(function(){const a=$('input[name="id"]')?.val()||"",i=$('input[name="title"]'),n={instance:void 0,busy:$("div.cherry-body").busy()};var t=$("div.post-setting-panel");const o=$("#setting-Modal").bootstrapModal();function r(t=!1){var e={title:i.val(),markdown:n.instance.getMarkdown()};if(e.title=e.title.trimStart().trimEnd(),Object.assign(e,o.find("form").toJson()||{}),0==e.infoType&&(e.info=function(t){let e=new RegExp("<[^<>]+>","g"),i=n.instance.getHtml(),a=i.replace(e,"");(a=a.replace(/\s*/g,"")).length>t&&(a=a.substring(0,t));return a}(200)),delete e.infoType,e.tags&&e.tags.length||delete e.tags,t||e.markdown.trimStart().trimEnd())return e.isPublish=!t,a&&(e.id=a),e;window.lycoris.totast.warn("文章内容不能为空")}async function s(t){var e;if(t)return(e=window.lycoris.createRequest()).url="/post/save",e.data={...t},(e=await e.post())&&0==e.resCode?(t.isPublish?(window.lycoris.totast.success("发布成功"),setTimeout(()=>{$("body").fadeOut(()=>{window.parent.lycoris.multitabs.remove(location.pathname,window.lycoris.console+"/post")})},1e3)):window.lycoris.totast.success("保存成功"),window.parent.lycoris.events.call("post.refresh"),e.data.id):void 0}t.find("button.btn-secondary").on("click",function(){$("body").fadeOut(()=>{window.parent.lycoris.multitabs.remove(location.pathname,window.lycoris.console+"/post")})}),t.find("button.btn-purple,button.btn-warning").on("click",async function(){if($(this).hasClass("btn-purple")){let t=i.val();if(!(t=t.trimStart().trimEnd()))return void window.lycoris.totast.warn("请先输入文章标题");if(!(t=(t=n.instance.getMarkdown()).trimStart().trimEnd()))return void window.lycoris.totast.warn("请输入文章内容");if(a)return void await s(r())}o.show()}),t.find("button.btn-info").on("click",async function(){$(this).attr("disabled","disabled");try{var t,e,i=r(!0);i.title?i.markdown&&i.markdown.trimStart().trimEnd()?(t=await s(i),0==a&&t&&(e=window.lycoris.console+"/post/update/"+t,window.parent.lycoris.multitabs.updateCurrentTab(i.title||"未命名",e),location.href=e)):window.lycoris.totast.warn("请输入文章内容"):window.lycoris.totast.warn("请输入文章标题")}finally{$(this).removeAttr("disabled")}}),t.find("button.btn-outline-dark,button.btn-dark").on("click",function(){var t=$(this).find("span.switch-text"),e=$(this).hasClass("btn-outline-dark");e?($(this).removeClass("btn-outline-dark").addClass("btn-dark"),t.text("开")):($(this).removeClass("btn-dark").addClass("btn-outline-dark"),t.text("关")),window.lycoris.totast.info("自动保存功能已"+(e?"开启":"关闭"))}),i.on("input",function(){var t=$(this).val(),t=t?t.length:0,e=($(this).next().find(">span:first-child").text(t),parseInt($(this).attr("maxlength")));t<e?$(this).next().removeClass("danger"):$(this).next().addClass("danger")}),o.find("button.folder").on("click",function(){window.lycoris.events.call("static-file-Modal.show",{fileType:0,uploadType:0,multiple:!1},t=>{o.find("img.icon").attr("src",t[0].url),o.find('input[name="icon"]').val(t[0].url),o.find("div.create-icon").removeClass("create-icon")})}),o.find('select[name="infoType"]').on("change",function(){1==$(this).val()?$('textarea[name="info"]').parent().slideDown(350):$('textarea[name="info"]').parent().slideUp(350)}),o.find(".modal-footer").on("click","button.save",async function(){a?o.hide():await s(r())}),o.find('textarea[name="info"]').on("input",function(){var t=$(this).val();t&&t.length&&$(this).parent().find(".max-length>span:first-child").text(t.length)}),o.find('select[name="category"]').next().find("button").on("click",async function(){$(this).attr("disabled","disabled");try{var t,e,i=window.lycoris.createRequest(),a=(i.url="/category/enum",await i.get());a&&0==a.resCode&&a.data.list&&a.data.list.length&&(e=(t=$('select[name="category"]').bootstrapSelectpicker()).val(),t.setOptions(a.data.list),t.set(e))}finally{$(this).removeAttr("disabled")}}),this.init=async()=>{var t=$('input[name="post-error"]').val();t&&(await window.lycoris.swal.error(t),setTimeout(()=>{$("body").fadeOut(()=>{window.parent.lycoris.multitabs.remove(location.pathname,window.lycoris.console+"/post")})},1e3)),window.lycoris.loading.hide(),n.instance=await async function(){n.busy.show("Cherry-Markdown 插件初始化中,请稍候...");try{var t,e,i={id:"cherry-markdown-container",value:"",editor:{codemirror:{theme:"default"},defaultModel:"edit&preview",convertWhenPaste:!0},engine:{global:{htmlWhiteList:"iframe|script|style"},syntax:{list:{listNested:!0},inlineCode:{theme:"red"},codeBlock:{theme:"dark",wrap:!0,lineNumber:!0}}},toolbars:{theme:"light ",showToolbar:!0,toolbar:["bold","size","color","header","|","hr","strikethrough","|","code","link","table","|","list",{insert:["serverFile","image","audio","video","formula"]},"graph","togglePreview"],sidebar:[],bubble:!1,float:!1,customMenu:{serverFile:Cherry.createMenuHook("网站附件",{iconName:"toc",onClick:function(){window.lycoris.events.call("static-file-Modal.show",{uploadType:2},t=>{if(t&&t.length)for(var e of t){let t="\r\n";0==e.fileType?t+=`![图片#B #S #R #60% #auto #center](${e.url})`:1==e.fileType?t+=`!audio[音频#center](${e.url})`:2==e.fileType?t+=`!video[视频#B #S #R #center](${e.url})`:t+=`[文件 #center](${e.url})`,n.instance.insert(t)}})}})},autoScrollByHashAfterInit:!0},fileUpload:async(t,e)=>{n.busy.show("文件上传中,请稍候...");try{var i=await window.lycoris.fileUpload(t,2);i&&0==i.resCode&&(0==i.data.fileType?e(i.data.url,{name:"图片",isBorder:!0,isShadow:!0,isRadius:!0,width:"60%",height:"auto"}):1==i.data.fileType?e(i.data.url,{name:"音频"}):2==i.data.fileType?e(i.data.url,{name:"视频",isBorder:!0,isShadow:!0,isRadius:!0}):e(i.data.url))}catch{}finally{n.busy.hide()}},callback:{}};return a&&((t=window.lycoris.createRequest()).url="/post/markdown",t.data={id:a},e=await t.get())&&0==e.resCode&&(i.value=e.data),new Cherry(i)}finally{n.busy.hide()}}(),$(".js-tags-input").each(function(){var t=$(this);t.tagsInput({height:t.data("height")?t.data("height"):"36px",width:"100%",defaultText:t.attr("placeholder"),removeWithBackspace:!0,delimiter:[","]})})},this.init()});