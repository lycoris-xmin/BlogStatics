$(function(){async function t(t,e){const a=window.lycoris.createRequest();a.url=`${n}/list`,a.data={pageIndex:t,pageSize:e};const s=$(".filter-panel").toJson();for(let t in s)s[t]&&(a.data[t]=s[t]);const i=await a.get();return i&&0==i.resCode?i.data:{}}function e(){i.options.toolbar=".table-tool",i.options.showCheckbox=!0,i.options.showColumns=!1,i.options.autoHeight=!0,i.options.resize=!0,i.columns=[{column:"route",title:"路由地址",class:"cell-content",render:function(t,e){return`<p class="route"><span class="badge badge-${"GET"==e.httpMethod?"info":"purple"} mr-2">${e.httpMethod}</span>${t.toLocaleLowerCase()}</p>`}},{column:"success",title:"响应状态",align:"center",width:"100px",render:function(t){return`<span class="badge badge-${t?"success":"danger"}">${t?"正常":"异常"}</span>`}},{column:"statusCode",title:"状态码",align:"center",width:"80px",render:function(t){let e="secondary";return t>=500?e="danger":t>=400?e="dark":t>=300&&(e="warning"),`<span class="statuscode badge badge-${e}">${t}</span>`}},{column:"elapsedMilliseconds",title:"耗时(ms)",width:"150px",align:"right",render:function(t){let e="";return e=t<=3e3?"var(--color-dark-light)":t<=1e4?"var(--color-warning)":"var(--color-danger)",`<span class="second" style="color:${e}">${t}</span>`}},{column:"ip",title:"来源IP",width:"150px",align:"left"},{column:"ipAddress",title:"IP属地",width:"250px",align:"left"},{column:"createTime",title:"请求时间",width:"180px"},{column:"action",title:"操作",class:"cell-action action-2",align:"center",render:function(t,e,a){let s='\n          <button class="info" data-toggle="tooltip" data-placement="top" title="详细信息">\n            <i class="mdi mdi-eye"></i>\n            <i class="mdi mdi-loading mdi-spin"></i>\n          </button>\n          ';return e.statusCode>400&&401!=e.statusCode&&(s=s.concat('\n            <button class="danger" data-toggle="tooltip" data-placement="top" title="IP管控">\n              <i class="mdi mdi-ip"></i>\n              <i class="mdi mdi-loading mdi-spin"></i>\n            </button>\n            ')),s},events:{"click .info":async function(t,e,s,n){const o=i.find("td>button.info[disabled]");if(o&&o.length>0)window.lycoris.totast.warn("其他数据正在获取中,请稍候");else{$(t.currentTarget).attr("disabled","disabled");try{await a(s)}finally{$(t.currentTarget).removeAttr("disabled")}}}}}],i.init(),i.request=t,i.loadCompelte=(()=>{$('[data-toggle="tooltip"]').tooltip()})}async function a(t){l.find("p.route").html(`<span class="badge badge-${"GET"==t.httpMethod?"info":"purple"} mr-2">${t.httpMethod}</span>${t.route.toLocaleLowerCase()}`),l.find("p.ip").text(t.ip),l.find("p.ipAddress").text(t.ipAddress);let e="#000";t.statusCode>=500?e="var(--color-danger)":t.statusCode>=400?e="var(--color-dark)":t.statusCode>=300&&(e="var(--color-warning)"),l.find("p.statusCode").text(t.statusCode).css("color",e);let a="";a=t.elapsedMilliseconds<=3e3?"var(--color-dark-light)":t.elapsedMilliseconds<=1e4?"var(--color-warning)":"var(--color-danger)",l.find("p.elapsedMilliseconds").text(`${t.elapsedMilliseconds} ms`).css("color",a);const i=window.lycoris.createRequest();i.url=`${n}/info`,i.data={id:t.id};const o=await i.get();if(o&&0==o.resCode){const t=l.find("ul.cookie").parent().parent();if(o.data.cookies){let e="";for(let t in o.data.cookies)e=e.concat(`<li><span class="key">${t}</span> <p>${o.data.cookies[t]}</p></li>`);l.find("ul.cookie").html(e),t.removeClass("hide")}else t.hasClass("hide")||t.addClass("hide");const e=l.find("ul.header").parent().parent();if(o.data.headers){let t="";for(let e in o.data.headers)t=t.concat(`<li><span class="key">${e}</span> <p>${o.data.headers[e]}</p></li>`);l.find("ul.header").html(t),e.removeClass("hide")}else t.hasClass("hide")||e.addClass("hide");l.find("pre.params").html(s(o.data.params||{})),l.find("pre.response").html(s(o.data.response||{}));const a=l.find("p.exception").parent().parent();o.data.exception?(l.find("p.exception").text(o.data.exception),a.removeClass("hide")):a.hasClass("hide")||a.addClass("hide");const n=l.find("p.stackTrace").parent().parent();o.data.stackTrace?(l.find("p.stackTrace").text(o.data.stackTrace),n.removeClass("hide")):a.hasClass("hide")||n.addClass("hide"),l.show()}}function s(t){if(t=t||{},"string"==typeof t)try{let e=JSON.parse(t);t=e}catch{return t}return t=JSON.stringify(t,void 0,2),t=t.replace(/&/g,"&").replace(/</g,"<").replace(/>/g,">"),t.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\\-]?\d+)?)/g,function(t){var e="number";return/^"/.test(t)?e=/:$/.test(t)?"key":"string":/true|false/.test(t)?e="boolean":/null/.test(t)&&(e="null"),'<span class="'+e+'">'+t+"</span>"})}const n="/log/request",i=$("#tb_departments").table(),o={search:$(".table-tool").find("button.btn-success"),delete:$(".table-tool").find("button.btn-danger")},l=$("#viewDetail-Modal").bootstrapModal();o.search.on("click",async function(){$(this).setBusy();try{await i.load()}finally{$(this).clearBusy()}}),o.delete.on("click",async function(){const t=i.getSelectRows();if(!t||!t.length)return void window.lycoris.totast.info("请选择要删除的数据");const e=await window.lycoris.swal.confirm("数据删除后不可恢复","确定要删除吗");if(e){$(this).setBusy();try{const e=window.lycoris.createRequest();e.url=`${n}/delete`,e.data={ids:t.map(t=>t.id)};const a=await e.post();a&&0==a.resCode&&(window.lycoris.totast.success("删除成功"),i.removeRow("id",e.data.ids))}finally{$(this).clearBusy()}}}),this.init=async function(){e(),window.lycoris.loading.hide(),await i.load()},this.init()});