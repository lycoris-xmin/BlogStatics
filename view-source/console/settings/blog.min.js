$(function(){function remindInit(){new Sortable(dom.find(".remind").find("ul")[0],{animation:150,easing:"cubic-bezier(1, 0, 0, 1)"}),dom.find(".remind").find("span.mdi-close").on("click",remindRemove)}function postImageRemove(){$(this).parent().parent().remove();const e=$(this).data("id");e&&delete images[e]}function autoSaveChange(){const val=dom.find(".selectpicker").val(),input=dom.find('input[name="second"]');eval(val)?input.removeAttr("disabled"):input.attr("disabled","disabled")}function createPostIconHtml(e,n=0){const i=`\n    <div>\n      <img src="${e}" onerror="javascript:this.src='/statics/images/404.png'" data-src="${e}" data-id="${n}"/>\n      <div class="flex-center-center overlay">\n        <span class="mdi mdi-delete" data-id="${n}"></span>\n      </div>\n    </div>\n    `,t=$(i);t.insertBefore("div.image-upload"),t.find(".mdi-delete").on("click",postImageRemove)}function createRemindHtml(e){const n=`\n    <li style="display:none">\n      <p>${e}</p>\n      <div class="flex-center-center">\n        <span class="mdi mdi-close"></span>\n      </div>\n    </li>\n    `,i=$(n);dom.find(".remind").find("ul").append(i),i.slideDown(200).css("display","grid"),i.find("span.mdi-close").on("click",remindRemove)}function remindRemove(){const e=$(this).parent().parent();e.slideUp(200,()=>{e.remove()})}const dom=$("#blog");let images={};const selectpicker=dom.find(".selectpicker").bootstrapSelectpicker();dom.find(".selectpicker").on("change",autoSaveChange),dom.find(".images").find(".mdi-delete").on("click",postImageRemove),dom.find("div.image-upload").on("click",function(){dom.find('input[type="file"]').trigger("click")}),dom.find('input[type="file"]').on("change",function(e){if(e.target.files&&e.target.files.length){const n=(new Date).getTime();images[n]=e.target.files[0];const i=window.lycoris.tool.createObjectURL(images[n]);createPostIconHtml(i,n),$(this).val("")}}),dom.find("button[addRemind]").on("click",async function(){const e=await window.lycoris.swal.custome({title:"添加留言提醒",input:"text",inputAttributes:{autocapitalize:"off"},showCancelButton:!0,confirmButtonText:"确 定",cancelButtonText:"取 消"});e.isConfirmed&&e.value&&createRemindHtml(e.value)}),dom.find("button[save]").on("click",async function(){$(this).setBusy();try{const e=dom.find("form").toJson();if(e.images=[],images&&Object.keys(images).length){let e=1;for(let n in images){if("string"==typeof images[n]){e++;continue}const i=await window.lycoris.fileUpload(images[n],1,`${e++}.webp`);if(!i||0!=i.resCode)return;$(`img[data-id="${n}"]`).data("src",i.data.url),images[n]=i.data.url}}const n=dom.find("div.images").find("img[data-id]");n.each((n,i)=>{e.images.push($(i).data("src"))}),e.messageRemind=[];const i=dom.find("div.remind").find("ul");i.find("li>p").each((n,i)=>{e.messageRemind.push($(i).text())});const t=window.lycoris.createRequest();t.url="/settings/blog",t.data={...e};const o=await t.post();o&&0==o.resCode&&window.lycoris.totast.success("保存成功")}finally{$(this).clearBusy()}}),this.init=function(){remindInit(),window.lycoris.events.on("blog",function(e){if(selectpicker.set(e.autoSave.toString()),dom.find('input[name="second"]').val(e.second),e.images&&e.images.length){let n=1;for(let i of e.images)createPostIconHtml(i,n),images[n++]=""}if(dom.find('input[name="commentFrequencySecond"]').val(e.commentFrequencySecond),e.messageRemind&&e.messageRemind.length)for(let n of e.messageRemind)createRemindHtml(n);dom.find('input[name="messageFrequencySecond"]').val(e.messageFrequencySecond),autoSaveChange()})},this.init()});