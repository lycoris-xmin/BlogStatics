$(function(){function n(){try{const n=$('script[type="application/json"]').text(),t=JSON.parse(n);t.configUploadChannel=parseInt(t.configUploadChannel),isNaN(t.configUploadChannel)||(p.configUploadChannel=t.configUploadChannel),t.uploadChannel&&t.uploadChannel.length&&(p.uploadChannel=t.uploadChannel)}catch(n){}}async function t(n,t){const a=window.lycoris.createRequest();a.url=`${s}/list`,a.data={pageIndex:n,pageSize:t};const e=$(".filter-panel").toJson();for(let n in e){const t=e[n];(t||"number"==typeof t)&&(a.data[n]=e[n])}const o=await a.get();return o&&0==o.resCode?(p.rows=o.data.list,o.data):{}}function a(){c.options.toolbar=".table-tool",c.options.showCheckbox=!0,c.options.showColumns=!1,c.options.autoHeight=!0,c.options.resize=!0,c.options.pageSizeResize=!0,c.columns=[{column:"fileName",title:"文件名称",class:"cell-fileName",render:function(n,t){let a="图片",e="info";1==t.fileType?(a="音频",e="cyan"):2==t.fileType?(a="视频",e="purple"):3==t.fileType&&(t.systemFile?(a="系统文件",e="danger"):(a="文件",e="pink"));let o=`\n          <div>\n            <a class="fileName" href="${t.path}/${n}" target="_blank">${n}</a>\n            <div class="flex-start-center">\n              <span class="path" title="${t.path}">${t.path}</span>\n              <span class="size">${t.fileSize}</span>\n              <span class="badge badge-${e}" data-fileType="${t.fileType}">${a}</span>\n            </div>\n          </div>\n          `;return o}},{column:"uploadChannel",title:"保存位置",align:"center",width:"100px",render:function(n){const t=p.uploadChannel.filter(t=>t.value==n);return t&&t.length&&t[0].name?`<span class="badge badge-${0==n?"danger":"info"}">${t[0].name}</span>`:'<span class="badge badge-secondary">未知</span>'}},{column:"localBack",title:"本地备份",width:"100px",align:"center",render:function(n,t){return t.uploadChannel>0?`<span class="badge badge-${n?"info":"secondary"}">${n?"已备份":"未备份"}</span>`:'<span class="badge badge-secondary" style="width:35px"> - </span>'}},{column:"use",title:"状态",width:"100px",align:"center",render:function(n){return`<span class="badge badge-${n?"info":"secondary"}">${n?"使用中":"未使用"}</span>`}},{column:"createTime",title:"上传时间",width:"180px"},{column:"action",title:"操作",class:"cell-action action-3",align:"center",render:function(n,t,a){let e='\n          <button class="info" data-toggle="tooltip" data-placement="top" title="详细信息">\n            <i class="mdi mdi-eye"></i>\n          </button>\n          ';return t.systemFile||(e=e.concat('\n            <button class="warning" data-toggle="tooltip" data-placement="top" title="检测状态">\n              <i class="mdi mdi-database-search"></i>\n              <i class="mdi mdi-loading mdi-spin"></i>\n            </button>\n          ')),t.localBack&&t.uploadChannel>0&&t.uploadChannel!=p.configUploadChannel&&(e=e.concat('\n          <button class="cyan" data-toggle="tooltip" data-placement="top" title="同步远端">\n            <i class="mdi mdi-cloud-upload"></i>\n            <i class="mdi mdi-loading mdi-spin"></i>\n          </button>\n          ')),!t.localBack&&t.uploadChannel>0&&(e=e.concat('\n            <button class="purple" data-toggle="tooltip" data-placement="top" title="本地备份">\n              <i class="mdi mdi-cloud-download"></i>\n              <i class="mdi mdi-loading mdi-spin"></i>\n            </button>\n            ')),e},events:{"click .info":function(n,t,a,e){p.showIndex=e,r.show()},"click .warning":function(n,t,a,o){e.call(n.currentTarget,a,o)}}}],c.init(),c.request=t,c.loadCompelte=(()=>{$('[data-toggle="tooltip"]').tooltip()})}async function e(n,t){if(p.check.length>=3)window.lycoris.totast.inf("只能同时验证三个文件的使用状态");else{$(this).setBusy();try{const a=window.lycoris.createRequest();a.url=`${s}/check/useState`,a.data={id:n.id};const e=await a.post();e&&0==e.resCode&&(window.lycoris.totast.success(`${n.fileName} 状态检测已提交后台任务`),p.check.push({index:t,row:n}))}finally{setTimeout(()=>{$(this).clearBusy()},5e3)}}}function o(n){const t=p.check.findIndex(t=>t.row.id==n.id);if(t>-1){const a=p.check[t];a.row.use=n.use,c.updateRow(a.index,a.row),p.check.splice(t,1),window.lycoris.totast.info(`${a.row.fileName} 检测结果: ${n.use?"使用中":"未使用"}`)}}function i(n){n==p.download.all&&(window.open(`${window.lycoris.console}/download/staticfile/all/${n}`,"_self"),d.download.clearBusy())}function l(n){const t=p.rows[n],a=r.find("div.view-file").find("div");let e="";e=0==t.fileType?`<img src="${t.pathUrl}" onerror="javascript:this.src='/statics/images/404.png'" />`:1==t.fileType?`<audio src="${t.pathUrl}" controls="controls"></audio>`:2==t.fileType?`<video src="${t.pathUrl}" controls="controls"></video>`:'<span class="mdi mdi-file"></span>',a.html(e),0==t.fileType&&r.find("img").on("click",function(){const n=$(this).attr("src");window.lycoris.open(n)}),r.find("span.value,a.value").each((n,a)=>{const e=$(a).data("field");let o=t[e];"uploadChannel"==e?o=p.uploadChannel.filter(n=>n.value==o)[0].name:"pathUrl"==e&&(o=`${location.protocol}//${location.host}${o}`),$(a).text(o||" - ")}),r.find("span.index").text(n+1)}const s="/staticfile",c=$("#tb_departments").table(),d={search:$(".table-tool").find("button.btn-success"),sync:$(".table-tool").find("button.btn-cyan"),download:$(".table-tool").find("button.btn-danger")},r=$("#viewDetail-Modal").bootstrapModal(),p={configUploadChannel:0,uploadChannel:0,download:{all:""},showIndex:-1,rows:[],check:[]};d.search.on("click",async function(){$(this).setBusy();try{await c.load()}finally{$(this).clearBusy()}}),d.download.on("click",async function(){await window.lycoris.swal.info("仅会下载本地已备份的所有文件，若要下载远端仓库的所有文件请自行处理！","下载提示"),$(this).setBusy();try{const n=window.lycoris.createRequest();n.url=`${s}/download/file/all`;const t=await n.post();t&&0==t.resCode&&(p.download.all=t.data)}catch{$(this).clearBusy()}}),r.handleShow(function(){p.showIndex>-1?l(p.showIndex):p.hide()}),r.find('span[data-field="pathUrl"],span[data-field="remoteUrl"]').on("click",function(){const n=$(this).text();" - "!=n&&window.lycoris.open(n)}),r.find("span.mdi-chevron-left,span.mdi-chevron-right").on("click",function(){const n=$(this).hasClass("mdi-chevron-right")?1:-1,t=parseInt(r.find("span.index").text());if(1==t&&n<0||t==p.rows.length&&n>0)return void window.lycoris.totast.info(n>0?"这已经是最后一条了":"这已经是第一条了");const a=t+n;r.find("span.index").text(a),l(a-1)}),this.init=function(){n(),a(),window.lycoris.loading.hide(),c.load(),window.lycoris.signalR.on("checkkFileUseState",o),window.lycoris.signalR.on("downloadAll",i)},this.init()});