$(function(){function t(){try{const t=$('script[type="application/json"]').text();d.status=JSON.parse(t)}catch(t){console.log(t)}}async function e(t,e){const a=window.lycoris.createRequest();a.url=`${o}/list`,a.data={pageIndex:t,pageSize:e};const n=$(".filter-panel").toJson();for(let t in n){const e=n[t];(e||"number"==typeof e)&&(a.data[t]=n[t])}const i=await a.get();return i&&0==i.resCode?(d.rows=i.data.list,i.data):{}}function a(){i.options.toolbar=".table-tool",i.options.showCheckbox=!1,i.options.showColumns=!1,i.options.autoHeight=!0,i.options.resize=!0,i.options.pageSizeResize=!0,i.columns=[{column:"avatar",title:"用户头像",align:"center",width:"220px",render:function(t,e){return`\n          <div class="flex-center-center">\n            <div class="avatar">\n               <img src="${t}" onerror="this.javascript:this.src='/statics/avatar/default_user.jpg'" />\n            </div>\n          </div>\n          `}},{column:"nickName",title:"用户昵称",align:"left"},{column:"email",title:"登录邮箱",align:"left"},{column:"lastOnlineTime",title:"最后在线时间",width:"180px",render:function(t){if(!t)return'<span class="badge badge-secondary"> - </span>';let e="success";return new Date-new Date(t)>3e5&&(e="danger"),`<span class="badge badge-${e}">${t}</span>`}},{column:"status",title:"状态",width:"100px",align:"center",render:function(t){const e=d.status.findIndex(e=>e.value==t);return color="secondary",1==t?color="info":100==t?color="danger":-1==t&&(color="dark"),`<span class="badge badge-${color}">${d.status[e].name}</span>`}},{column:"createTime",title:"注册时间",width:"180px"},{column:"action",title:"操作",class:"cell-action action-2",align:"center",render:function(t,e,a){let n='\n          <button class="info" data-toggle="tooltip" data-placement="top" title="编辑">\n            <i class="mdi mdi-pencil"></i>\n            <i class="mdi mdi-loading mdi-spin"></i>\n          </button>\n          ';return n=n.concat('\n          <button class="warning" data-toggle="tooltip" data-placement="top" title="状态审核">\n            <i class="mdi mdi-check"></i>\n            <i class="mdi mdi-loading mdi-spin"></i>\n          </button>\n        '),n},events:{"click .info":function(t,e,a,o){n.call(t.currentTarget,o,a)},"click .warning":function(t,e,a,n){d.showIndex=n,d.row=a,r.audit.show()}}}],i.init(),i.request=e,i.loadCompelte=(()=>{$('[data-toggle="tooltip"]').tooltip()})}async function n(t,e){$(this).setBusy();try{const a=window.lycoris.createRequest();a.url=`${o}/userlink`,a.data={id:e.id};const n=await a.get();n&&0==n.resCode&&(d.showIndex=t,d.row={...e,...n.data},r.createOrUpdate.show())}finally{$(this).clearBusy()}}const o="/user",i=$("#tb_departments").table(),s={create:$(".table-tool").find("button.btn-info"),search:$(".table-tool").find("button.btn-success")},d={status:[],showIndex:-1,row:{}},r={createOrUpdate:$("#create-update-Modal").bootstrapModal(),audit:$("#audit-Modal").bootstrapModal()},c={modalStatus:$("#audit-Modal").find('select[name="status"]').bootstrapSelectpicker()};s.create.on("click",function(){d.row&&"0"!=d.row.id&&(d.row={id:"0"}),r.createOrUpdate.show()}),s.search.on("click",async function(){$(this).setBusy();try{await i.load()}finally{$(this).clearBusy()}}),r.createOrUpdate.find("button[more]").on("click",function(){const t=$(this).data("show")||0;t?r.createOrUpdate.find("div.more").slideUp():r.createOrUpdate.find("div.more").slideDown(),$(this).data("show",t?0:1)}),r.createOrUpdate.find("button[save]").on("click",async function(){const t=r.createOrUpdate.find("form").toJson();if(t.email)if($.regex.email(t.email))if(t.nickName)if(t.nickName.length>10)window.lycoris.totast.warn("用户昵称长度不能超过十个字符");else if(t.password&&t.password.length<6)window.lycoris.totast.warn("密码不能少于6个字符");else{$(this).setBusy();try{const e=window.lycoris.createRequest();e.url=`${o}/${-1==d.showIndex?"create":"update"}`,e.data={...t},d.showIndex>-1&&(e.data.id=d.row.id);const a=await e.post();a&&0==a.resCode&&(window.lycoris.totast.success("新增用户成功"),-1==d.showIndex?i.createRow(a.data,!1):i.updateRow(d.showIndex,a.data),r.createOrUpdate.hide())}finally{$(this).clearBusy()}}else window.lycoris.totast.warn("用户昵称不能为空");else window.lycoris.totast.warn("登录邮箱格式错误");else window.lycoris.totast.warn("登录邮箱不能为空")}),r.createOrUpdate.handleShow(()=>{r.createOrUpdate.find(".modal-title").text(-1==d.showIndex?"新增用户":"编辑用户"),d.showIndex>-1?(r.createOrUpdate.find('input[name="email"]').attr("readonly","readonly"),r.createOrUpdate.find('div[data-role="password"]').hide(),d.row&&r.createOrUpdate.find("form").formAutoFill(d.row)):(r.createOrUpdate.find('input[name="email"]').removeAttr("readonly"),r.createOrUpdate.find('div[data-role="password"]').show())}),r.createOrUpdate.handleHidden(()=>{d.showIndex>-1&&(d.showIndex=-1,r.createOrUpdate.find("button[more]").data("show",0),r.createOrUpdate.find("div.more").slideUp(),r.createOrUpdate.find("input").val(""))}),r.audit.handleShow(()=>{-1==d.shwoIndex&&r.audit.hide(),c.modalStatus.set(d.row.status),r.audit.find("textarea").val(d.row.remark)}),r.audit.handleHidden(()=>{r.audit.showIndex=-1,r.audit.row={}}),r.audit.find("button[save]").on("click",async function(){const t=r.audit.find("form").toJson();$(this).setBusy();try{const e=window.lycoris.createRequest();e.url=`${o}/audit`,e.data={id:d.row.id,...t};const a=await e.post();a&&0==a.resCode&&(window.lycoris.totast.success("状态审核成功"),d.row.status=t.status,d.row.remark=t.remark,i.updateRow(d.showIndex,d.row),r.audit.hide())}finally{$(this).clearBusy()}}),this.init=function(){t(),a(),window.lycoris.loading.hide(),i.load()},this.init()});